# GeoData Service

## 1. Обзор

`geodata-service` — это ключевой микросервис в рамках "ГеоИнфоСистемы", отвечающий за управление всеми векторными геопространственными данными и метаданными слоев изображений. Он предоставляет централизованный API для создания, чтения, обновления и удаления геообъектов и их логической группировки по проектам.

## 2. Основные обязанности

- **Управление проектами:** Создание логических контейнеров (проектов) для группировки геообъектов и управление доступом к ним для совместной работы.
- **Управление геообъектами:** Полный цикл CRUD-операций для трех типов векторных данных:
    - **Точки** (`ProjectPoint`)
    - **Линии** (`ProjectMultiline`)
    - **Полигоны** (`ProjectPolygon`)
- **Управление слоями снимков:** Хранение и предоставление метаданных о растровых слоях (например, аэрофотоснимках с дронов), опубликованных в GeoServer.
- **Асинхронная индексация:** Публикация событий (создание, обновление, удаление) в Apache Kafka для последующей индексации данных в `search-service`.
- **Автоматические вычисления:** Автоматический расчет длины для линий и площади для полигонов с использованием триггеров базы данных PostGIS.

## 3. Технологический стек

- **Фреймворк:** Spring Boot 3
- **Язык:** Java 17
- **База данных:** PostgreSQL с расширением PostGIS
- **Управление миграциями БД:** Liquibase
- **Работа с геометриями:** Hibernate Spatial, JTS (Java Topology Suite)
- **Сборка:** Apache Maven

## 4. Модели данных

Сервис оперирует следующими основными JPA-сущностями:

- `Project`: Проект, который объединяет геообъекты.
- `ProjectAccess`: Таблица для управления доступом пользователей к проектам.
- `ProjectPoint`: Точечный геообъект.
- `ProjectMultiline`: Линейный геообъект.
- `ProjectPolygon`: Полигональный геообъект.
- `ImageryLayer`: Метаданные растрового слоя из GeoServer.

Все гео-сущности привязаны к проекту и содержат колонку `geom` типа `Geometry` для хранения пространственных данных.

## 5. API Endpoints

Сервис предоставляет REST API по базовому пути `/api/geodata`.

### Проекты (`/project`)
- `POST /`: Создать проект.
- `GET /{id}`: Получить проект.
- `GET /page-query`: Получить список проектов.
- `PUT /{id}`: Обновить проект.
- `DELETE /{id}`: Удалить проект.
- `POST /{projectId}/share`: Поделиться проектом.

### Слои снимков (`/imagery-layer`)
- `POST /`: Создать метаданные слоя.
- `GET /{id}`: Получить метаданные слоя.
- `GET /page-query`: Получить список слоев.
- `PUT /{id}`: Обновить метаданные слоя.
- `DELETE /{id}`: Удалить метаданные слоя.

### Точки (`/points`)
- `POST /`: Создать точку.
- `GET /`: Получить все точки.
- `GET /{id}`: Получить точку по ID.
- `GET /by-project-id/{projectId}`: Получить все точки в проекте.
- `PUT /{id}`: Обновить точку.
- `DELETE /{id}`: Удалить точку.
- `POST /{id}/upload-main-image`: Загрузить изображение для точки.

### Линии (`/multilines`)
- `POST /`: Создать линию.
- `GET /`: Получить все линии.
- `GET /{id}`: Получить линию по ID.
- `GET /by-project-id/{projectId}`: Получить все линии в проекте.
- `PUT /{id}`: Обновить линию.
- `DELETE /{id}`: Удалить линию.
- `POST /{id}/upload-main-image`: Загрузить изображение для линии.

### Полигоны (`/polygons`)
- `POST /`: Создать полигон.
- `GET /`: Получить все полигоны.
- `GET /{id}`: Получить полигон по ID.
- `GET /by-project-id/{projectId}`: Получить все полигоны в проекте.
- `PUT /{id}`: Обновить полигон.
- `DELETE /{id}`: Удалить полигон.
- `POST /{id}/upload-main-image`: Загрузить изображение для полигона.

## 6. База данных

Схема базы данных управляется с помощью **Liquibase**.
- **Схема:** `geodata`
- **Расширения PostgreSQL:** `uuid-ossp`, `postgis`
- **Ключевые особенности:**
    - Пространственные **GIST-индексы** для всех колонок с геометрией для обеспечения высокой производительности гео-запросов.
    - **Триггеры** для автоматического расчета площади и длины.
    - Внешние ключи с каскадным удалением (`ON DELETE CASCADE`) от геообъектов к проектам.

Миграции находятся в директории `src/main/resources/db/changelog`.

## 7. Сборка и запуск

Для сборки и запуска сервиса локально используйте Maven:

```bash
# Сборка проекта
mvn clean install

# Запуск сервиса
mvn spring-boot:run
```
