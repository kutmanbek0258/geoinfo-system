## **Финальное Архитектурное Описание Системы Интерактивной Карты**

### **1\. Общие Принципы и Архитектурная Модель**

Система построена на принципах **микросервисной архитектуры** с четким разделением ответственности (SoC) и использованием модели **Database per Microservice**.

* **API Gateway:** Является единой точкой входа, централизует аутентификацию и маршрутизацию.  
* **Асинхронность:** Используется **Kafka** для обеспечения актуальности поискового индекса и выполнения фоновых задач.  
* **Геопространственный Стек:** Для обработки и публикации геоданных используется связка **GeoServer** и **OpenLayers**.

### **2\. Технологический Стек**

| Категория | Технология | Роль |
| :---- | :---- | :---- |
| **Фронтенд** | **Vue.js** | Разработка одностраничного приложения (SPA). |
| **Картография** | **OpenLayers** | Отображение интерактивной карты, работа с WMS/WMTS (GeoServer) и векторными слоями. |
| **Бэкенд** | **Spring Boot** | Разработка всех микросервисов. |
| **API Gateway** | **Spring Cloud Gateway** | Маршрутизация, централизованная валидация JWT-токенов. |
| **Геосервер** | **GeoServer** | Публикация растровых данных (GeoTIFF) по протоколам WMS/WMTS. |
| **Базы Данных (Гео)** | **PostgreSQL/PostGIS** | Хранение векторных данных и метаданных слоев дронов. |
| **Базы Данных (Док.)** | **PostgreSQL** | Хранение метаданных документов (отдельная база данных). |
| **Хранение Файлов** | **MinIO** (S3-совместимое) | Хранение бинарных файлов (документов, KML, файлов дронов). |
| **Поиск** | **Elasticsearch** | Полнотекстовый и геопространственный поиск. |
| **Сообщения** | **Kafka** | Асинхронное взаимодействие (для индексации). |
| **Редактирование** | **OnlyOffice** | Встраиваемый редактор документов. |

### **3\. Структура Микросервисов**

Бэкенд состоит из трех основных микросервисов, каждый со своим изолированным хранилищем.

| Микросервис | Основные Функции | Хранилище (DB) | Kafka Topic (Источник) |
| :---- | :---- | :---- | :---- |
| **Geo Data Service** | CRUD векторных объектов (маркеры, линии, полигоны), управление метаданными слоев дронов. | **PostgreSQL/PostGIS** | geo.data.events |
| **Document Service** | CRUD метаданных документов, управление файлами в MinIO, логика OnlyOffice Callback. | **PostgreSQL** | doc.data.events |
| **Search Service** | Асинхронное потребление событий из Kafka, выполнение поисковых запросов. | **Elasticsearch** | (Потребитель) |

### **4\. Принципы Взаимодействия**

#### **4.1. Авторизация и Доступ**

* **Аутентификация:** Выполняется внешним Spring Authorization Server (исключен из внутренней разработки).  
* **API Gateway:** Валидирует JWT, извлекает данные пользователя и передает их в заголовках микросервисам.  
* **Микросервисы:** Используют декларативную авторизацию (@PreAuthorize("hasAnyAuthority(...)")).

#### **4.2. Асинхронная Индексация (Kafka)**

Для индексации данных в **Elasticsearch** используется асинхронный паттерн:

1. **Geo Data Service** и **Document Service** отправляют сообщения в свои топики (geo.data.events, doc.data.events) при любом изменении сущности (CREATED, UPDATED, DELETED).  
2. **Search Service** постоянно слушает эти топики, выполняя асинхронную индексацию.

#### **4.3. Интеграция с GeoServer**

1. **Публикация:** Администратор вручную публикует GeoTIFF в GeoServer, используя выделенную директорию (/geoserver\_data/drone\_files) и создает WMS/WMTS слои.  
2. **Метаданные:** Администратор вносит layerName и метаданные в **Geo Data Service** через API.  
3. **Отображение:** **OpenLayers** получает layerName из **Geo Data Service** и напрямую запрашивает растровые тайлы у **GeoServer** по протоколу WMS/WMTS.

### **5\. Схема Развертывания (Docker Compose)**

Среда разработки и тестирования полностью контейнеризована, включая все компоненты: API Gateway, все микросервисы (как заглушки), две отдельные БД PostgreSQL, MinIO, Kafka/Zookeeper, Elasticsearch, GeoServer и OnlyOffice.

**Целостность данных:** Базы данных изолированы, что полностью соответствует принципу **Database per Microservice**.