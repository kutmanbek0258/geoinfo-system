# Докеризация проекта "ГеоИнфоСистема"

В этом документе описывается архитектура докеризации проекта, а также инструкции по запуску и управлению контейнерами для различных сред.

## Обзор

Проект полностью контейнеризирован с использованием **Docker** и **Docker Compose**. Это позволяет развернуть весь стек, включая микросервисы приложения и все необходимые сторонние сервисы (базы данных, брокер сообщений и т.д.), с помощью нескольких команд.

Архитектура разделена на три основных файла:
- `docker-compose.yml`: Базовый файл, определяющий все сервисы, их зависимости и внутренние сетевые взаимодействия. Он не содержит специфичных для окружения настроек, таких как публикация портов.
- `docker-compose.dev.yml`: Файл для **среды разработки**. Он расширяет базовый конфиг, публикуя порты всех сервисов на хост-машину для удобства отладки и прямого доступа.
- `docker-compose.prod.yml`: Файл для **производственной среды**. Он также расширяет базовый конфиг, но публикует наружу только необходимые для работы приложения порты (API Gateway, Frontend и т.д.), оставляя внутреннюю инфраструктуру изолированной.

## Состав сервисов

Весь стек можно разделить на следующие группы:

#### 1. Инфраструктура Spring Cloud
- `config-server`: Сервер конфигураций.
- `discovery-server`: Сервер обнаружения сервисов (Eureka).
- `api-gateway`: Единая точка входа для всех API-запросов.

#### 2. Микросервисы приложения
- `auth-service`: Сервис аутентификации и управления пользователями.
- `geodata-service`: Сервис для работы с векторными геоданными.
- `document-service`: Сервис для управления документами и файлами.
- `search-service`: Сервис для полнотекстового и геопространственного поиска.
- `frontend`: Клиентское SPA-приложение (Vue.js), обслуживаемое через Nginx.

#### 3. Базы данных и хранилища
- `postgres-auth`: База данных PostgreSQL для `auth-service`.
- `postgres-geodata`: База данных PostGIS для `geodata-service`.
- `postgres-docs`: База данных PostgreSQL для `document-service`.
- `redis-auth`: Кэш Redis, используемый `auth-service`.
- `elasticsearch`: Поисковый движок для `search-service`.
- `minio`: S3-совместимое объектное хранилище для файлов.

#### 4. Сторонние сервисы
- `kafka` & `zookeeper`: Брокер сообщений для асинхронного взаимодействия.
- `geoserver`: Сервер для публикации геоданных (например, GeoTIFF) по WMS/WMTS протоколам.
- `onlyoffice-doc-server`: Сервер для онлайн-редактирования документов.

## Инструкции по запуску

### Среда разработки (Development)

Этот режим предназначен для локальной разработки. Он собирает образы из исходного кода и пробрасывает порты всех сервисов на `localhost`, что позволяет напрямую обращаться к API каждого сервиса или подключаться к базам данных.

**Команда для запуска:**
```shell
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up --build
```
- `--build`: Флаг для принудительной пересборки образов, если в исходном коде были изменения.
- Для остановки стека используйте `Ctrl+C` или команду `docker-compose ... down` в другом терминале.

### Производственная среда (Production)

Этот режим предназначен для развертывания приложения. Он обеспечивает лучшую безопасность, скрывая внутренние компоненты и открывая доступ только к публичным точкам входа.

**Команда для запуска:**
```shell
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```
- `-d`: Запуск в фоновом (detached) режиме.

В этом режиме наружу публикуются только следующие порты:
- `8080`: Фронтенд-приложение.
- `9005`: API Gateway.
- `8085`: GeoServer.
- `8081`: OnlyOffice Document Server.
- `9001`: Auth Service (для нужд процесса аутентификации).

## Управление стеком

- **Запуск:** `docker-compose ... up`
- **Остановка:** `docker-compose ... down`
- **Просмотр логов:** `docker-compose ... logs -f [имя_сервиса]` (например, `logs -f geodata-service`)
- **Пересборка образов:** `docker-compose ... build [имя_сервиса]`

## Конфигурация и хранение данных

### Конфигурация сервисов
- **Бэкенд-сервисы** получают свои настройки (например, URL баз данных, адрес Kafka) через переменные окружения, определенные в `docker-compose.yml`.
- **Фронтенд** использует гибридный подход. Для разработки используется прокси в `vite.config.ts`. Для продакшена в образ встроены плейсхолдеры (например, `__VITE_API_GATEWAY_URL__`), которые заменяются на реальные значения из переменных окружения при старте контейнера с помощью скрипта `entrypoint.sh`.

### Хранение данных
- **PostgreSQL:** Данные хранятся в анонимных Docker-вольюмах. Это означает, что при удалении контейнера командой `docker-compose down` данные **сохраняются**. Однако, для их полного удаления нужно выполнить `docker-compose down -v`.
- **MinIO:** Данные хранятся в вольюме, который монтируется из локальной директории (`/minio_data` на хосте). Это обеспечивает простоту доступа к файлам и их резервного копирования.
- **GeoServer:** Данные для GeoServer (например, GeoTIFF файлы) монтируются из локальной директории `./geoserver_uploads`.
