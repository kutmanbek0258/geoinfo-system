# Докеризация проекта "ГеоИнфоСистема"

В этом документе описывается архитектура докеризации проекта, а также инструкции по запуску и управлению контейнерами для различных сред.

## Обзор

Проект полностью контейнеризирован с использованием **Docker** и **Docker Compose**. Это позволяет развернуть весь стек, включая микросервисы приложения и все необходимые сторонние сервисы (базы данных, брокер сообщений и т.д.), с помощью нескольких команд.

Архитектура разделена на три основных файла:
- `docker-compose.yml`: Базовый файл, определяющий все сервисы, их зависимости и внутренние сетевые взаимодействия. Он использует переменные окружения для всех конфигурируемых параметров.
- `docker-compose.dev.yml`: Файл для **среды разработки**. Он расширяет базовый конфиг, публикуя порты всех сервисов на хост-машину для удобства отладки и прямого доступа.
- `docker-compose.prod.yml`: Файл для **производственной среды**. Он также расширяет базовый конфиг, но публикует наружу только необходимые для работы приложения порты (API Gateway, Frontend и т.д.), оставляя внутреннюю инфраструктуру изолированной.

**Управление переменными окружения:**
Для удобства и безопасности, все переменные окружения, используемые проектом, теперь разделены на два файла:
- **`.env.example`**: Содержит примеры и описания **нечувствительных** переменных окружения (порты, хосты, URL-адреса сервисов, общие настройки). Этот файл может быть частью системы контроля версий.
- **`.env.secrets.example`**: Содержит примеры и описания **чувствительных** переменных окружения (пароли, секреты API, учетные данные для баз данных и внешних сервисов). Этот файл служит шаблоном; его копия `.env.secrets` с реальными значениями не должна попадать в систему контроля версий.

## Состав сервисов

Весь стек можно разделить на следующие группы:

#### 1. Инфраструктура Spring Cloud
- `config-server`: Сервер конфигураций.
- `discovery-server`: Сервер обнаружения сервисов (Eureka).
- `api-gateway`: Единая точка входа для всех API-запросов.

#### 2. Микросервисы приложения
- `auth-service`: Сервис аутентификации и управления пользователями.
- `geodata-service`: Сервис для работы с векторными геоданными.
- `document-service`: Сервис для управления документами и файлами.
- `search-service`: Сервис для полнотекстового и геопространственного поиска.
- `stream-service`: Сервис для управления потоковыми трансляциями (например, с камер Hikvision).
- `frontend`: Клиентское SPA-приложение (Vue.js), обслуживаемое через Nginx.

#### 3. Базы данных и хранилища
- `postgres-auth`: База данных PostgreSQL для `auth-service`.
- `postgres-geodata`: База данных PostGIS для `geodata-service`.
- `postgres-docs`: База данных PostgreSQL для `document-service`.
- `redis-auth`: Кэш Redis, используемый `auth-service`.
- `elasticsearch`: Поисковый движок для `search-service`.
- `minio`: S3-совместимое объектное хранилище для файлов.

#### 4. Сторонние сервисы
- `kafka` & `zookeeper`: Брокер сообщений для асинхронного взаимодействия.
- `geoserver`: Сервер для публикации геоданных (например, GeoTIFF) по WMS/WMTS протоколам.
- `onlyoffice-doc-server`: Сервер для онлайн-редактирования документов.
- `mediamtx`: Сервер для преобразования RTSP в WebRTC/HLS для стриминга видео.

## Инструкции по запуску

Для запуска проекта необходимо создать файлы `.env` и `.env.secrets` в корневой директории, скопировав в них содержимое из `.env.example` и `.env.secrets.example` соответственно, и заполнив реальными значениями.

### Среда разработки (Development)

Этот режим предназначен для локальной разработки. Он собирает образы из исходного кода и пробрасывает порты всех сервисов на `localhost`, что позволяет напрямую обращаться к API каждого сервиса или подключаться к базам данных.

**Команда для запуска:**
```shell
docker-compose --env-file .env.secrets --env-file .env.example -f docker-compose.yml -f docker-compose.dev.yml up --build
```
- `--build`: Флаг для принудительной пересборки образов, если в исходном коде были изменения.
- `--env-file .env.secrets`: Указывает Docker Compose загрузить чувствительные переменные из файла `.env.secrets`.
- `--env-file .env.example`: Указывает Docker Compose загрузить нечувствительные переменные из файла `.env.example`.
- Для остановки стека используйте `Ctrl+C` или команду `docker-compose ... down` в другом терминале.

### Производственная среда (Production)

Этот режим предназначен для развертывания приложения. Он обеспечивает лучшую безопасность, скрывая внутренние компоненты и открывая доступ только к публичным точкам входа.

**Команда для запуска:**
```shell
docker-compose --env-file .env.secrets --env-file .env.example -f docker-compose.yml -f docker-compose.prod.yml up -d --build
```
- `-d`: Запуск в фоновом (detached) режиме.

В этом режиме наружу публикуются только следующие порты (настраиваются в `.env.example`):
- `${FRONTEND_PORT}`: Фронтенд-приложение.
- `${API_GATEWAY_PORT}`: API Gateway.
- `${GEOSERVER_PORT}`: GeoServer.
- `${ONLYOFFICE_PORT}`: OnlyOffice Document Server.
- `${AUTH_SERVICE_PORT}`: Auth Service (для нужд процесса аутентификации).
- `${MEDIAMTX_HLS_PORT}`: MediaMTX HLS-потоки.

## Управление стеком

- **Запуск:** `docker-compose --env-file .env.secrets --env-file .env.example ... up`
- **Остановка:** `docker-compose --env-file .env.secrets --env-file .env.example ... down`
- **Просмотр логов:** `docker-compose --env-file .env.secrets --env-file .env.example ... logs -f [имя_сервиса]` (например, `logs -f geodata-service`)
- **Пересборка образов:** `docker-compose --env-file .env.secrets --env-file .env.example ... build [имя_сервиса]`

## Конфигурация и хранение данных

### Конфигурация сервисов
Все настройки сервисов, включая учетные данные баз данных, секреты API и прочие параметры, теперь управляются через переменные окружения, которые загружаются из файлов `.env.example` (для нечувствительных данных) и `.env.secrets` (для чувствительных данных). Это повышает безопасность и гибкость конфигурации.

### Хранение данных
- **PostgreSQL:** Данные хранятся в анонимных Docker-вольюмах. Это означает, что при удалении контейнера командой `docker-compose down` данные **сохраняются**. Однако, для их полного удаления нужно выполнить `docker-compose down -v`.
- **MinIO:** Данные хранятся в вольюме, который монтируется из локальной директории (`/minio_data` на хосте). Это обеспечивает простоту доступа к файлам и их резервного копирования.
- **GeoServer:** Данные для GeoServer (например, GeoTIFF файлы) монтируются из локальной директории `./geoserver_uploads`.

## Переменные окружения

Все переменные окружения, используемые проектом, теперь четко разделены и описаны в файлах `.env.example` и `.env.secrets.example`. Пожалуйста, обратитесь к этим файлам для получения актуальной информации по каждой переменной, её назначению и значению по умолчанию.

### Основные категории переменных:
-   **Глобальные настройки сети и портов**: Настройки хоста, портов для всех сервисов.
-   **Настройки CORS**: Разрешенные домены для междоменных запросов.
-   **Домены сервисов**: Полные URL-адреса для доступа к сервисам (Auth, MediaMTX).
-   **Переменные конфигурации фронтенда (Vite)**: URL-ададреса, используемые фронтендом.
-   **Настройки брокеров сообщений (Kafka)**: Адреса Kafka.
-   **Настройки поисковых систем (Elasticsearch)**: Адреса Elasticsearch.
-   **Настройки Redis**: Адреса и параметры Redis.
-   **Имена баз данных PostgreSQL**: Названия баз данных для каждого сервиса.
-   **Другие переменные приложения**: Различные общие настройки.
-   **Настройки MediaMTX (стриминг)**: Параметры для управления потоковыми трансляциями.

### Чувствительные переменные (в `.env.secrets.example`):
-   **Учетные данные и секреты баз данных**: Имена пользователей и пароли для PostgreSQL и Redis.
-   **Учетные данные и секреты для межсервисного взаимодействия**: `CLIENT_ID` и `CLIENT_SECRET` для внутренней проверки токенов.
-   **Учетные данные и секреты внешних OAuth2 провайдеров**: `CLIENT_ID` и `CLIENT_SECRET` для GitHub, Google, Yandex, а также учетные данные для SMTP.
-   **Учетные данные и секреты инфраструктурных сервисов**: `ROOT_USER`/`PASSWORD` для MinIO, `ADMIN_USER`/`PASSWORD` для GeoServer, `JWT_SECRET` для OnlyOffice.

**Важно:** Никогда не коммитьте файл `.env.secrets` с реальными учетными данными в систему контроля версий!

