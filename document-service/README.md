# Document Service

## 1. Обзор

`document-service` — это микросервис в составе "ГеоИнфоСистемы", отвечающий за полный жизненный цикл документов. Он управляет загрузкой файлов, хранением их метаданных, интеграцией с онлайн-редактором OnlyOffice и уведомлением других частей системы об изменениях.

## 2. Архитектура и бизнес-процессы

Сервис является центральным узлом для всех операций с файлами.

1.  **Загрузка документа:**
    - Пользователь через API загружает файл, связанный с конкретным `geoObjectId`.
    - `DocumentService` сохраняет бинарный файл в **MinIO** с помощью `MinioFileStoreService`, получая уникальный ключ (`minioObjectKey`).
    - В транзакционной базе данных **PostgreSQL** создается запись в таблице `documents` с метаданными (имя файла, размер, `geoObjectId`, `minioObjectKey`).
    - Сервис обрабатывает теги: находит существующие или создает новые в таблице `tags`.
    - `KafkaProducerService` отправляет событие `DOCUMENT_CREATED` в топик `doc.data.events`, чтобы `search-service` мог его проиндексировать.
2.  **Редактирование в OnlyOffice:**
    - Фронтенд запрашивает у `OnlyOfficeController` специальный конфигурационный объект.
    - Сервис генерирует временную (presigned) URL для доступа к файлу в MinIO и JWT-токен для защиты сессии редактирования.
    - После того как пользователь сохраняет документ в OnlyOffice, тот отправляет `callback`-запрос на `document-service`.
    - Сервис скачивает изменененную версию файла по URL из callback-а и перезаписывает существующий файл в MinIO.
3.  **Скачивание и удаление:** Сервис предоставляет эндпоинты для скачивания и удаления документов, которые также включают проверку прав доступа и соответствующие операции в MinIO и PostgreSQL.

## 3. Технологический стек

- **Фреймворк:** Spring Boot 3
- **Язык:** Java 17
- **База данных:** PostgreSQL
- **Хранилище файлов:** MinIO (S3-совместимое)
- **Онлайн-редактор:** OnlyOffice
- **Брокер сообщений:** Apache Kafka
- **Управление миграциями БД:** Liquibase
- **Сборка:** Apache Maven

## 4. Модели данных и схема БД

- **JPA Entities:**
    - `Document`: Основная сущность, хранящая метаданные файла и его связь с `geoObjectId`.
    - `Tag`: Сущность для тегов.
    - Связь между ними (`@ManyToMany`) реализуется через промежуточную таблицу `document_tag_link`.
- **Схема БД (Liquibase):**
    - **`documents`**: Основная таблица с метаданными.
    - **`tags`**: Справочник уникальных тегов.
    - **`document_tag_link`**: Таблица для связи "многие-ко-многим" между документами и тегами.
    - Все внешние ключи используют `ON DELETE CASCADE` для обеспечения целостности данных.

## 5. API Endpoints

Сервис предоставляет REST API по базовому пути `/api/documents`.

### DocumentController
- `GET /geo/{geoObjectId}`
    - **Описание:** Получить список документов для гео-объекта.
    - **Права:** `DOCUMENT_READ`
- `POST /`
    - **Описание:** Загрузить новый документ (multipart/form-data).
    - **Права:** `DOCUMENT_CREATE`
- `GET /{documentId}/download`
    - **Описание:** Скачать файл документа.
    - **Права:** `DOCUMENT_READ`
- `DELETE /{documentId}`
    - **Описание:** Удалить документ.
    - **Права:** `DOCUMENT_DELETE`
- `PUT /{documentId}`
    - **Описание:** Обновить метаданные документа (описание, теги).
    - **Права:** `DOCUMENT_UPDATE`
- `GET /{documentId}/presigned-url`
    - **Описание:** Сгенерировать временную ссылку для прямого доступа к файлу.
    - **Права:** `DOCUMENT_READ`
- `GET /public/image/{documentId}`
    - **Описание:** Публичный эндпоинт для получения файлов, помеченных как "main-image". Не требует аутентификации.

### OnlyOfficeController
- `GET /{documentId}/onlyoffice-config`
    - **Описание:** Получить конфигурацию для инициализации редактора OnlyOffice.
    - **Права:** `DOCUMENT_READ`
- `POST /{documentId}/onlyoffice-callback`
    - **Описание:** Callback-эндпоинт для OnlyOffice. Принимает уведомления о сохранении документа. Не требует аутентификации (защищен JWT-токеном OnlyOffice).

## 6. Сборка и запуск

Для сборки и запуска сервиса локально используйте Maven:

```bash
# Сборка проекта
mvn clean install

# Запуск сервиса
mvn spring-boot:run
```
