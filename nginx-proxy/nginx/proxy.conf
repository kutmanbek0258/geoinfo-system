# /etc/nginx/nginx.conf
# Docker-friendly final config for nginx-proxy
# HTTP active. HTTPS block is commented for later activation.

user  nginx;
worker_processes auto;
worker_rlimit_nofile 200000;
error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    use epoll;
    worker_connections 65536;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;
    types_hash_max_size 2048;
    server_tokens off;

    # file cache (speeds up static/HLS)
    open_file_cache max=20000 inactive=60s;
    open_file_cache_valid 120s;
    open_file_cache_min_uses 2;
    open_file_cache_errors off;

    # structured access log (JSON)
    log_format json_combined escape=json '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_addr":"$upstream_addr",'
        '"http_referrer":"$http_referer",'
        '"http_user_agent":"$http_user_agent"'
    '}';
    access_log /var/log/nginx/access.log json_combined;

    # Compression
    gzip on;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_vary on;
    gzip_proxied any;

    # Proxy defaults / tuning
    proxy_buffers 8 32k;
    proxy_buffer_size 64k;
    proxy_busy_buffers_size 128k;
    proxy_temp_file_write_size 256k;
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 90s;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # preserve original proto
    map $http_x_forwarded_proto $forwarded_proto {
        default $http_x_forwarded_proto;
        '' $scheme;
    }

    # Basic rate limiting (adjust)
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    limit_req_zone $binary_remote_addr zone=req:10m rate=20r/s;

    # Cache zones (mount /var/cache/nginx as volume)
    proxy_cache_path /var/cache/nginx/hls_cache levels=1:2 keys_zone=hls_cache:200m max_size=50g inactive=12h use_temp_path=off;
    proxy_cache_path /var/cache/nginx/geocache levels=1:2 keys_zone=geocache:500m max_size=100g inactive=7d use_temp_path=off;
    proxy_cache_path /var/cache/nginx/static_cache levels=1:2 keys_zone=static_cache:50m max_size=10g inactive=30d use_temp_path=off;

    ####################################################
    # Upstreams (use container names from docker-compose)
    ####################################################
    upstream frontend_backend {
        server frontend:8080;
        keepalive 16;
    }

    upstream api_gateway {
        server api-gateway:9005;
        keepalive 16;
    }

    upstream auth_service {
        server auth-service:9001;
        keepalive 8;
    }

    upstream geoserver_backend {
        server geoserver:8080;
        keepalive 16;
    }

    upstream onlyoffice_backend {
        server onlyoffice-doc-server:80;
        keepalive 8;
    }

    upstream hls_backend {
        server mediamtx:8888;
        keepalive 64;
    }

    ########################################################
    # Server for SSO subdomain -> auth-service (incl. /client)
    # Access: http://sso.localhost/
    ########################################################
    server {
        listen 80;
        listen [::]:80;
        server_name sso.localhost;

        # health probe
        location = /healthz {
            access_log off;
            return 200 'OK';
        }

        # All traffic on sso.localhost goes to auth_service
        # preserve the entire path so /client remains /client
        location / {
            proxy_pass http://auth_service;          # <-- NO trailing slash: preserve prefix
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /;   # optional: informs backend it's at root of this host
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $http_connection;
        }

        # Optional static fallback if auth-service serves index for SPA routes
        # (no special handling needed since auth-service serves /client and can return index.html)
    }

    #########################################
    # HTTP server (ACTIVE) - edge entrypoint
    #########################################
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name localhost;

        # Health
        location = /healthz {
            access_log off;
            return 200 'OK';
        }

        ############################################################################
        # FRONTEND SPA: internal '/' (no prefix change)  -> external '/'
        # Proxy without trailing slash to preserve paths
        ############################################################################
        location / {
            proxy_pass http://frontend_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $forwarded_proto;
            proxy_buffering off;
            proxy_read_timeout 90s;
        }

        ############################################################################
        # AUTH CLIENT SPA: internal '/'  -> external '/sso' (strip /sso)
        # Use trailing slash in proxy_pass to remove /sso prefix before forwarding.
        # Provide X-Forwarded-Prefix so backend knows original path (useful if SPA expects it).
        ############################################################################
#         location /sso/ {
#             proxy_set_header X-Forwarded-Prefix /sso;
#             proxy_pass http://auth_client_spa;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $forwarded_proto;
#             proxy_buffering off;
#             proxy_read_timeout 90s;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection $http_connection;
#         }

        ############################################################################
        # AUTH SERVICE: internal '/auth' -> external '/auth' (preserve prefix)
        # proxy_pass WITHOUT trailing slash to keep prefix
        ############################################################################
#         location /auth/ {
#             proxy_pass http://auth_service;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $forwarded_proto;
#
#             # OAuth2 often uses large headers/cookies
#             proxy_buffer_size 128k;
#             proxy_buffers 16 128k;
#             proxy_busy_buffers_size 256k;
#
#             proxy_next_upstream error timeout http_502 http_503 http_504;
#             proxy_next_upstream_tries 3;
#         }

        ############################################################################
        # API Gateway: internal '/api' -> external '/api' (preserve prefix)
        ############################################################################
        location /api/ {
            proxy_pass http://api_gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $forwarded_proto;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 90s;

            limit_req zone=req burst=30 nodelay;
        }

        ############################################################################
        # GeoServer: internal '/geoserver' -> external '/geoserver' (preserve prefix)
        # heavy tile responses -> cache
        ############################################################################
        location /geoserver/ {
            proxy_pass http://geoserver_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $forwarded_proto;

            proxy_cache geocache;
            proxy_cache_valid 200 1h;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            add_header X-Cache-Status $upstream_cache_status;

            proxy_buffering on;
            proxy_buffers 16 128k;
            proxy_busy_buffers_size 256k;
            proxy_temp_file_write_size 256k;
        }

        ############################################################################
        # OnlyOffice: internal '/' -> external '/onlyoffice' (strip /onlyoffice)
        # strip prefix using trailing slash in proxy_pass; add forwarded prefix header.
        ############################################################################
        location /onlyoffice/ {
            proxy_set_header X-Forwarded-Prefix /onlyoffice;
            proxy_pass http://onlyoffice_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $forwarded_proto;

            proxy_read_timeout 120s;
            client_max_body_size 500m;
            proxy_buffering off;
        }

        ############################################################################
        # HLS: .m3u8 and .ts segments (cache aggressively)
        ############################################################################
        location ~* \.(m3u8)$ {
            proxy_pass http://hls_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_cache hls_cache;
            proxy_cache_key "$scheme://$host$request_uri";
            proxy_cache_valid 200 1h;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating;

            proxy_buffering off;
            sendfile on;
            aio threads;
            tcp_nopush on;
            add_header X-Cache-Status $upstream_cache_status;
        }

        location ~* \.(ts)$ {
            proxy_pass http://hls_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_cache hls_cache;
            proxy_cache_valid 200 12h;
            proxy_cache_use_stale error timeout updating;

            proxy_buffering off;
            sendfile on;
            aio threads;
            tcp_nopush on;
            add_header X-Cache-Status $upstream_cache_status;
        }

        ############################################################################
        # Static fallback proxied to API gateway (optional: keep if API serves static)
        # Remove if frontend handles all static files.
        ############################################################################
        location /static/ {
            proxy_pass http://api_gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_cache static_cache;
            proxy_cache_valid 200 30d;
            proxy_cache_use_stale error timeout updating;
            add_header X-Cache-Status $upstream_cache_status;
        }

        # Fallback for unmatched requests (optional)
        location /_nginx_error/ {
            return 502 "Bad gateway";
        }
    } # end server 80

    ########################################################################
    # HTTPS BLOCK (commented). When you have certs, uncomment and configure.
    ########################################################################
    # server {
    #     listen 443 ssl http2 reuseport;
    #     listen [::]:443 ssl http2 reuseport;
    #     server_name <YOUR_DOMAIN>;
    #
    #     ssl_certificate /etc/letsencrypt/live/<YOUR_DOMAIN>/fullchain.pem;
    #     ssl_certificate_key /etc/letsencrypt/live/<YOUR_DOMAIN>/privkey.pem;
    #     ssl_session_cache shared:SSL:50m;
    #     ssl_session_timeout 1d;
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_prefer_server_ciphers off;
    #
    #     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    #     add_header X-Frame-Options "SAMEORIGIN" always;
    #     add_header X-Content-Type-Options "nosniff" always;
    #     add_header Referrer-Policy "no-referrer-when-downgrade" always;
    #
    #     # replicate the same location blocks here (or use include)
    # }
}
