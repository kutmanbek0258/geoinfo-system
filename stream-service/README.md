# Stream Service

## 1. Обзор

`stream-service` — это микросервис в составе "ГеоИнфоСистемы", отвечающий за управление жизненным циклом видеотрансляций с IP-камер. Он выступает в роли моста между основной платформой и стриминговым сервером **MediaMTX**, позволяя запускать и останавливать трансляции "по требованию".

Сервис реализует безопасный доступ к HLS-потокам с помощью JWT-токенов. Технология HLS была выбрана в качестве основной из-за её простоты реализации и широкой совместимости с веб-браузерами.

## 2. Архитектура и Принцип работы

Логика работы сервиса построена на взаимодействии трех компонентов: **GeoInfoSystem**, **stream-service** и **MediaMTX**.

1.  **Запрос на старт трансляции:**
    - Пользователь на `frontend` нажимает кнопку просмотра для объекта-камеры.
    - `frontend` отправляет запрос на `POST /api/streams/start` с `geoObjectId` (ID камеры).
    - `stream-service` получает этот запрос.
2.  **Получение данных и запуск потока:**
    - `stream-service` с помощью Feign-клиента обращается к `geodata-service` и получает учетные данные для камеры (IP, порт, логин, пароль), которые хранятся в поле `characteristics`.
    - На основе этих данных формируется RTSP-адрес камеры.
    - `stream-service` отправляет команду на API-сервер `MediaMTX` для добавления нового пути (path) с указанным RTSP-адресом в качестве источника (`source`).
    - `MediaMTX` начинает забирать видеопоток с камеры и преобразовывать его в HLS.
3.  **Передача HLS-ссылки клиенту:**
    - `stream-service` формирует финальную HLS-ссылку. В эту ссылку в качестве query-параметра добавляется JWT-токен текущего пользователя (`.../index.m3u8?token=...`).
    - Ссылка возвращается на `frontend`, который передает ее в видеоплеер.
4.  **Аутентификация просмотра:**
    - `MediaMTX` настроен так, что перед отдачей HLS-сегментов он обращается к внешнему `authentication webhook` — эндпоинту `POST /api/streams/auth` в `stream-service`.
    - `stream-service` получает этот запрос, извлекает JWT-токен из query-параметра и валидирует его через `auth-service` (используя introspection-эндпоинт).
    - Если токен валиден, сервис возвращает `200 OK`, и `MediaMTX` отдает видео клиенту. В противном случае возвращается `401 Unauthorized`.
5.  **Остановка трансляции:**
    - Когда пользователь закрывает плеер, `frontend` отправляет запрос на `POST /api/streams/stop`.
    - `stream-service` отправляет команду на API `MediaMTX` для удаления соответствующего пути, что останавливает захват RTSP-потока и освобождает ресурсы.

## 3. API Endpoints

Все эндпоинты доступны по базовому пути `/api/streams`.

| Метод  | Путь         | Описание                                                                                                |
|:-------|:-------------|:--------------------------------------------------------------------------------------------------------|
| `POST` | `/start`     | Запускает трансляцию для камеры. Принимает `{"geoObjectId": "..."}`. Возвращает HLS URL с JWT-токеном.     |
| `POST` | `/stop`      | Останавливает трансляцию для камеры. Принимает `{"geoObjectId": "..."}`.                                 |
| `POST` | `/auth`      | **Внутренний эндпоинт.** Используется `MediaMTX` для аутентификации запросов на просмотр HLS-потоков.    |

## 4. Взаимодействие с другими сервисами

-   **`geodata-service` (Синхронно, Feign):**
    -   Получает данные о камере (IP, порт, учетные данные) по её ID.
-   **`auth-service` (Синхронно, RestTemplate):**
    -   Выполняет интроспекцию JWT-токенов для проверки прав доступа к HLS-потоку.
-   **`MediaMTX` (Синхронно, Feign):**
    -   Управляет жизненным циклом трансляций через REST API `MediaMTX`.

## 5. Конфигурация

Сервис является клиентом `config-server` и `discovery-server`. Ключевые переменные окружения, необходимые для работы:

-   `mediamtx.api.url`: URL для доступа к REST API `MediaMTX`.
-   `mediamtx.hls.url`: Базовый публичный URL, по которому будут доступны HLS-трансляции.

## 6. Сборка и запуск

Для сборки и запуска сервиса локально используйте Maven:

```bash
# Сборка проекта
mvn clean install

# Запуск сервиса
mvn spring-boot:run
```
Сервис также полностью контейнеризирован и запускается вместе с остальными компонентами системы через `docker-compose`.
