# Сервис Аутентификации (Auth Service)

Сервис `auth-service` является центральным компонентом платформы "GeoInfo System", отвечающим за управление идентификацией и доступом пользователей. Он обрабатывает регистрацию, вход, а также выдачу и проверку токенов доступа.

## Основные возможности

-   Регистрация новых пользователей.
-   Аутентификация пользователей по логину и паролю.
-   Генерация JSON Web Tokens (JWT) при успешном входе.
-   Валидация и обновление (refresh) токенов.
-   Предоставление пользовательского интерфейса для страниц входа и регистрации.

## Архитектура

Сервис имеет гибридную архитектуру и состоит из двух частей:

1.  **Backend API (Java/Spring Boot)**: REST API, реализующее всю бизнес-логику аутентификации.
2.  **Client (Vue.js)**: Небольшое фронтенд-приложение, расположенное в папке `/client`, которое предоставляет пользователям UI для взаимодействия с сервисом (формы входа, регистрации и т.д.).

## Технологический стек

### Backend
-   **Java 17+**
-   **Spring Boot**
-   **Spring Security** для управления безопасностью.
-   **Maven** для сборки проекта.
-   **Liquibase** для миграций базы данных.
-   **PostgreSQL** (предположительно) в качестве основной СУБД.
-   **JJWT** для работы с JSON Web Tokens.

### Client
-   **Vue.js**
-   **Node.js / npm** для управления зависимостями и запуска.
-   **Axios** для выполнения HTTP-запросов к бэкенду.

## Ключевые эндпоинты API

Ниже представлен полный список эндпоинтов, сгруппированных по их функциональному назначению.

### Управление аккаунтом (`/account`)

| Метод | Путь | Защита (Authority) | Описание |
| :---- | :--- | :--- | :--- |
| `GET` | `/current` | `GET_OWN_DATA` | Получение информации о текущем пользователе. |
| `POST`| `/current` | `CHANGE_OWN_DATA`| Сохранение изменений профиля текущего пользователя (включая аватар). |
| `DELETE`| `/current` | `DELETE_OWN_ACCOUNT`| Удаление профиля текущего пользователя. |
| `GET` | `/avatar/current`| `GET_OWN_DATA` | Получение аватарки текущего пользователя. |

### Регистрация (`/registration`)

| Метод | Путь | Защита | Описание |
| :---- | :--- | :--- | :--- |
| `POST`| `/init` | `permitAll` | Инициализация регистрации: получение данных и отправка OTP-кода. |
| `POST`| `/confirm`| `permitAll` | Подтверждение регистрации с помощью OTP-кода. |

### Сброс пароля (`/reset-password`)

| Метод | Путь | Защита | Описание |
| :---- | :--- | :--- | :--- |
| `POST`| `/init` | `permitAll` | Инициализация сброса пароля (отправка OTP на email). |
| `POST`| `/confirm`| `permitAll` | Подтверждение OTP-кода. |
| `POST`| `/set` | `permitAll` | Установка нового пароля после подтверждения. |

### Смена пароля (`/change-password`)

| Метод | Путь | Защита (Authority) | Описание |
| :---- | :--- | :--- | :--- |
| `POST`| `/init` | `CHANGE_OWN_PASSWORD` | Инициализация смены пароля для авторизованного пользователя (отправка OTP). |
| `POST`| `/confirm`| `CHANGE_OWN_PASSWORD` | Подтверждение смены пароля с помощью OTP. |

### Администрирование пользователей (`/admin-user`)

| Метод | Путь | Защита (Authority) | Описание |
| :---- | :--- | :--- | :--- |
| `GET` | `/search` | `GET_ADMIN_USER_DATA` | Поиск по пользователям-администраторам SSO. |
| `POST`| `/assign-admin`| `ASSIGN_ADMIN_ROLE` | Назначить роль администратора SSO пользователю. |
| `POST`| `/dismiss/{userId}`| `ASSIGN_ADMIN_ROLE` | Снять роль администратора SSO с пользователя. |
| `GET` | `/avatar/{userId}`| `GET_ADMIN_USER_DATA` | Получить аватарку пользователя-администратора. |

### Управление OAuth2 клиентами (`/oauth2-client`)

| Метод | Путь | Защита (Authority) | Описание |
| :---- | :--- | :--- | :--- |
| `GET` | `/{clientId}` | `GET_OAUTH_CLIENT_DATA` | Получение информации о клиенте по `clientId`. |
| `GET` | `/search` | `GET_OAUTH_CLIENT_DATA` | Поиск клиентов по параметрам. |
| `POST`| `` | `CHANGE_OAUTH_CLIENT_DATA`| Создание или изменение OAuth2 клиента. |
| `POST`| `/gen-secret/{clientId}`| `CHANGE_OAUTH_CLIENT_DATA`| Сгенерировать новый `clientSecret` для клиента. |
| `DELETE`| `/{clientId}` | `DELETE_OAUTH_CLIENT_DATA`| Удалить OAuth2 клиента. |

### Справочники (`/reference`)

| Метод | Путь | Защита | Описание |
| :---- | :--- | :--- | :--- |
| `GET` | `/auth-methods` | `permitAll` | Получение справочника методов авторизации. |
| `GET` | `/grant-types` | `permitAll` | Получение справочника доступных `grant_type`. |
| `GET` | `/scopes` | `permitAll` | Получение справочника доступных `scope`. |

### Управление токенами (`/user-token`)

| Метод | Путь | Защита (Authority) | Описание |
| :---- | :--- | :--- | :--- |
| `GET` | `/search` | `GET_OWN_TOKENS` | Получение списка выданных токенов для текущего пользователя. |
| `POST`| `/recall` | `RECALL_OWN_TOKENS` | Отозвать токен по его ID. |

### Прочее

| Метод | Путь | Защита (Authority) | Описание |
| :---- | :--- | :--- | :--- |
| `GET` | `/security-session/user` | `isAuthenticated()` | Получение информации о текущей сессии пользователя. |
| `GET` | `/user-event/search` | `GET_OWN_EVENTS` | Получение событий безопасности для текущего пользователя. |
| `GET` | `/resource/user/{userId}/avatar` | `SCOPE_SSO.USER_AVATAR` | Получение аватарки пользователя (для ресурсных серверов). |

## Запуск и разработка

### Необходимые компоненты
-   **JDK 17** или выше
-   **Apache Maven**
-   **Node.js и npm**
-   **Docker** и **Docker Compose**

### 1. Настройка базы данных
1.  Создайте базу данных PostgreSQL для сервиса.
2.  Настройте подключение в файле `src/main/resources/application.properties` (или через переменные окружения).
3.  При первом запуске **Liquibase** автоматически применит все необходимые миграции для создания схемы БД.

### 2. Запуск Backend (Java API)

```bash
# Перейдите в директорию сервиса
cd /data/data/com.termux/files/home/geoinfo-system/auth-service

# Соберите проект и запустите его
mvn spring-boot:run
```
Сервер запустится на порту, указанном в `application.properties` (например, 8081).

### 3. Запуск Client (Vue.js UI)

```bash
# Перейдите в директорию клиента
cd /data/data/com.termux/files/home/geoinfo-system/auth-service/client

# Установите зависимости
npm install

# Запустите сервер для разработки
npm run serve
```
Клиентское приложение будет доступно по адресу `http://localhost:8080` (или другому порту, указанному в конфигурации).

## Запуск с помощью Docker

Самый простой способ запустить сервис — использовать Docker Compose из корневой директории проекта.

```bash
# Из корня проекта /data/data/com.termux/files/home/geoinfo-system
# Запустить только auth-service и его зависимости (например, базу данных)
docker-compose up -d auth-service

# Чтобы запустить все сервисы
docker-compose up -d
```