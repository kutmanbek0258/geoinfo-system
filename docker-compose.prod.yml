version: '3.8'

services:
  # ====== Databases (оставлены без изменений) ======
  postgres-auth:
    networks:
      - internal

  redis-auth:
    networks:
      - internal

  postgres-geodata:
    networks:
      - internal

  postgres-docs:
    networks:
      - internal

  # ====== Message Broker ======
  kafka:
    depends_on:
      - zookeeper
    networks:
      - internal

  zookeeper:
    networks:
      - internal

  # ====== Elasticsearch for Search Service ======
  elasticsearch:
    networks:
      - internal

  # ====== GEOSERVER ======
  geoserver:
    networks:
      - external

  # ======= MINIO STORAGE ======
  minio:
    networks:
      - internal

  # ====== ONLYOFFICE DOC SERVER ======
  onlyoffice-doc-server:
    networks:
      - internal
      - external

  # ====== Config, Discovery, Gateway ======
  config-server:
    networks:
      - internal
    environment:
      SPRING_PROFILES_ACTIVE: prod

  discovery-server:
    networks:
      - internal
    environment:
      SPRING_PROFILES_ACTIVE: prod

  api-gateway:
    ports:
      - "80:8080"
    networks:
      - internal
      - external
    depends_on:
      - config-server
      - discovery-server
    environment:
      SPRING_PROFILES_ACTIVE: prod

  # ====== Microservices ======
  auth-service:
    networks:
      - internal
    depends_on:
      - postgres-auth
      - redis-auth
      - kafka
      - config-server
      - discovery-server
    environment:
      SPRING_PROFILES_ACTIVE: prod

  geodata-service:
    networks:
      - internal
    depends_on:
      - postgres-geodata
      - kafka
      - config-server
      - discovery-server
    environment:
      SPRING_PROFILES_ACTIVE: prod

  document-service:
    networks:
      - internal
    depends_on:
      - postgres-docs
      - kafka
      - config-server
      - discovery-server
    environment:
      SPRING_PROFILES_ACTIVE: prod

  search-service:
    networks:
      - internal
    depends_on:
      - elasticsearch
      - kafka
      - config-server
      - discovery-server
    environment:
      SPRING_PROFILES_ACTIVE: prod

networks:
  internal:
    driver: bridge
    internal: true
  external:
    driver: bridge